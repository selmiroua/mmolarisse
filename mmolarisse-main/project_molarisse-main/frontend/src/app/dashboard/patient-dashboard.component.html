<div class="dashboard-container">
  <div class="animated-background"></div>
  
  <header class="dashboard-header">
    <div class="header-content">
      <div class="logo">
        Molarisse - Patient
      </div>
      <div class="right-header">
        <app-notification-bell></app-notification-bell>
        <button class="menu-toggle" [class.active]="isMenuOpen" (click)="toggleMenu()">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </button>
      </div>
    </div>
    
    <nav class="nav-menu" [class.open]="isMenuOpen">
      <a (click)="showDashboard(); isMenuOpen = false" [class.active]="activeSection === 'dashboard'">Accueil</a>
      <a (click)="showAppointments(); isMenuOpen = false" [class.active]="activeSection === 'appointments'">Mes Rendez-vous</a>
      <a (click)="showProfile(); isMenuOpen = false" [class.active]="activeSection === 'profile'">Mon Profile</a>
      <a (click)="navigateToBookAppointment(); isMenuOpen = false" [class.active]="activeSection === 'book-appointment'">Prendre Rendez-Vous</a>
      <button class="logout-btn" (click)="logout()">Déconnexion</button>
    </nav>
  </header>

  <main class="dashboard-content">
    <!-- Dashboard Overview Section -->
    <div *ngIf="activeSection === 'dashboard'">
      <h2>Bienvenue dans votre espace patient</h2>
      
      <div class="appointments-section">
        <div class="section-header">
          <h3>Mes Rendez-vous</h3>
          <button mat-button color="primary" (click)="showAppointments()">
            Voir tout <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
        
        <div *ngIf="loading" class="loading-spinner">
          <mat-spinner diameter="40"></mat-spinner>
        </div>

        <div class="dashboard-appointment-list" *ngIf="!loading && appointments.length > 0">
          <div class="dashboard-appointment-card" *ngFor="let appointment of appointments.slice(0, 3); let i = index">
            <div class="card-status" [ngClass]="getStatusClass(appointment.status)">
              <mat-icon *ngIf="appointment.status === 'COMPLETED'">check_circle</mat-icon>
              <mat-icon *ngIf="appointment.status === 'REJECTED'">close</mat-icon>
              <span>{{getStatusLabel(appointment.status)}}</span>
            </div>
            
            <div class="card-header">
              <span>Rendez-vous avec {{getDoctorName(appointment.doctor)}}</span>
            </div>
            
            <div class="card-body">
              <div class="info-row date-time">
                <mat-icon>event</mat-icon>
                <span>{{appointment.appointmentDateTime | date:'dd/MM/yyyy à HH:mm'}}</span>
              </div>
              
              <div class="info-row type">
                <mat-icon>medical_services</mat-icon>
                <span>{{getAppointmentTypeLabel(appointment.appointmentType)}}</span>
              </div>
              
              <div class="info-row urgency">
                <mat-icon>{{getCaseTypeIcon(appointment.caseType)}}</mat-icon>
                <span>{{getCaseTypeLabel(appointment.caseType)}}</span>
              </div>
            </div>
            
            <div class="card-actions">
              <button mat-button color="primary" 
                    *ngIf="appointment.status === 'PENDING'"
                    (click)="rescheduleAppointment(appointment)">
                <mat-icon>edit</mat-icon>
                Modifier
              </button>
              <button mat-button color="warn" 
                    *ngIf="appointment.status === 'PENDING' || appointment.status === 'ACCEPTED'"
                    (click)="cancelAppointment(appointment)">
                <mat-icon>cancel</mat-icon>
                Annuler
              </button>
              <button mat-stroked-button color="primary" (click)="viewAppointmentDetails(appointment)">
                <mat-icon>visibility</mat-icon>
                Détails
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="!loading && appointments.length === 0" class="no-appointments">
          <div class="empty-icon">
            <mat-icon>event_busy</mat-icon>
          </div>
          <h3>Aucun rendez-vous</h3>
          <p>Vous n'avez aucun rendez-vous programmé pour le moment.</p>
          <button mat-raised-button color="primary" (click)="navigateToBookAppointment()">
            <mat-icon>add</mat-icon>
            Prendre un rendez-vous
          </button>
        </div>
      </div>
    </div>
    
    <!-- Appointments Tab View -->
    <div *ngIf="activeSection === 'appointments'" class="appointments-full-view">
      <div class="appointments-header">
        <div class="header-title">
          <h2>Appointments</h2>
        </div>
        <div class="header-actions">
          <div class="search-bar">
            <mat-icon>search</mat-icon>
            <input type="text" placeholder="Search" (input)="filterAppointments($event)">
          </div>
          <div class="view-controls">
            <button class="view-button" matTooltip="List view">
              <mat-icon>view_agenda</mat-icon>
            </button>
            <button class="view-button" matTooltip="Grid view">
              <mat-icon>grid_view</mat-icon>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Tab Navigation -->
      <div class="appointment-tabs">
        <button class="tab-button" [class.active]="activeTab === 'upcoming'" (click)="setActiveTab('upcoming')">
          Upcoming <span class="count">{{ getTabCount('PENDING', 'ACCEPTED') }}</span>
        </button>
        <button class="tab-button" [class.active]="activeTab === 'cancelled'" (click)="setActiveTab('cancelled')">
          Cancelled <span class="count">{{ getTabCount('CANCELED', 'REJECTED') }}</span>
        </button>
        <button class="tab-button" [class.active]="activeTab === 'completed'" (click)="setActiveTab('completed')">
          Completed <span class="count">{{ getTabCount('COMPLETED') }}</span>
        </button>
        
        <div class="date-filter">
          <button mat-button class="date-range-button">
            <mat-icon>calendar_today</mat-icon>
            <span>{{ dateRange }}</span>
          </button>
          <button mat-button class="filter-button" matTooltip="Filter options">
            <span>Filter By</span>
            <mat-icon>keyboard_arrow_down</mat-icon>
          </button>
        </div>
      </div>
      
      <!-- Loading Indicator -->
      <div *ngIf="appointmentsLoading" class="appointments-loading">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Chargement des rendez-vous...</p>
      </div>
      
      <!-- Error State -->
      <div *ngIf="appointmentsError && !appointmentsLoading" class="appointments-error">
        <mat-icon color="warn">error_outline</mat-icon>
        <h3>Impossible de charger les rendez-vous</h3>
        <p>{{ appointmentsErrorMessage }}</p>
        <button mat-raised-button color="primary" (click)="refreshAppointments()">
          <mat-icon>refresh</mat-icon>
          Réessayer
        </button>
      </div>
      
      <!-- Modern Appointment List -->
      <div class="modern-appointments-container" *ngIf="!appointmentsLoading && !appointmentsError && getFilteredAppointments().length > 0">
        <div class="appointment-list">
          <div class="appointment-card" *ngFor="let appointment of getFilteredAppointments(); let i = index">
            <div class="doctor-section">
              <div class="avatar-container">
                <img [src]="appointment.doctor?.profilePicture || 'assets/images/default-avatar.png'" 
                    alt="Doctor avatar" 
                    (error)="handleImageError($event)">
              </div>
              
              <div class="doctor-info">
                <div class="appointment-id">#Apt{{ i + 1 | number:'3.0-0' }}</div>
                <h3 class="doctor-name">{{ getDoctorName(appointment.doctor) }}</h3>
              </div>
            </div>
            
            <div class="appointment-details">
              <div class="appointment-time">
                <mat-icon>access_time</mat-icon>
                {{ appointment.appointmentDateTime | date:'dd MMM yyyy HH:mm' }}
              </div>
              
              <div class="appointment-badges">
                <span class="badge">{{ getAppointmentTypeLabel(appointment.appointmentType) }}</span>
                <span class="badge case-type" [ngClass]="appointment.caseType.toLowerCase()">{{ getCaseTypeLabel(appointment.caseType) }}</span>
              </div>
            </div>
            
            <div class="contact-info">
              <div class="contact-item">
                <mat-icon>email</mat-icon>
                <span>{{ getDoctorEmail(appointment.doctor) }}</span>
              </div>
              <div class="contact-item">
                <mat-icon>phone</mat-icon>
                <span>{{ getDoctorPhone(appointment.doctor) }}</span>
              </div>
            </div>
            
            <div class="action-buttons">
              <button class="circle-button" matTooltip="View details" (click)="viewAppointmentDetails(appointment)">
                <mat-icon>visibility</mat-icon>
              </button>
              <button class="circle-button edit-button" 
                     *ngIf="appointment.status === 'PENDING' || appointment.status === 'ACCEPTED'"
                     (click)="rescheduleAppointment(appointment)">
                <mat-icon>edit</mat-icon>
                <span class="edit-text">Modifier</span>
              </button>
              <button class="circle-button" matTooltip="Message">
                <mat-icon>chat</mat-icon>
              </button>
              <button class="primary-button" *ngIf="getAppointmentTypeForDisplay(appointment.appointmentType) === 'VIDEO_CALL'">
                <mat-icon>videocam</mat-icon>
                Attend
              </button>
              <button class="primary-button" *ngIf="getAppointmentTypeForDisplay(appointment.appointmentType) !== 'VIDEO_CALL'" (click)="viewAppointmentDetails(appointment)">
                Voir détails
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- No Appointments Message -->
      <div *ngIf="!appointmentsLoading && !appointmentsError && getFilteredAppointments().length === 0" class="no-appointments">
        <div class="empty-icon">
          <mat-icon>event_busy</mat-icon>
        </div>
        <h3>Aucun rendez-vous</h3>
        <p>Vous n'avez aucun rendez-vous programmé pour le moment.</p>
        <button mat-raised-button color="primary" (click)="navigateToBookAppointment()">
          <mat-icon>add</mat-icon>
          Prendre un rendez-vous
        </button>
      </div>
    </div>
    
    <!-- Profile View -->
    <div *ngIf="activeSection === 'profile'">
      <app-profile></app-profile>
    </div>

    <!-- Book Appointment View -->
    <div *ngIf="activeSection === 'book-appointment'">
      <app-book-appointment></app-book-appointment>
    </div>
  </main>
</div>


